#!/bin/perl -w
use strict;

#    ___ a
#  f|\|/|b (hij)
#    - - g G
#  e|/|\|c (mlk)
#    === d
#
#    ___ 
#   |\|/|
#    - - 
#   |/|\|
#    ___ 
#
my $not_used =<<'_E';
  a    ,  d    ,
 fhijb , cmlke ,
  g G  ,  G g  ,
 eklmc , bjihf ,
  d    ,  a    ,

  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,
 |\|/| , |\|/| , |\|/| , |\|/| , |\|/| , |\|/| , |\|/| , |\|/| , |\|/| , |\|/| , |\|/| , |\|/| , |\|/| , |\|/| , |\|/| , |\|/| ,
  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,
 |/|\| , |/|\| , |/|\| , |/|\| , |/|\| , |/|\| , |/|\| , |/|\| , |/|\| , |/|\| , |/|\| , |/|\| , |/|\| , |/|\| , |/|\| , |/|\| ,
  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,

       ,       ,       ,       ,  ___  ,       ,  ___  ,       ,       ,       ,       ,       ,       ,       ,       ,       ,
       ,     | ,   | | ,   | | , | |   , |\|/  ,  \|   ,   |   ,    /  ,  \    ,  \|/  ,   |   ,       ,       ,       ,    /  ,
       ,       ,       ,  - -  ,  - -  ,  - -  ,  -    ,       ,       ,       ,  - -  ,  - -  ,       ,  - -  ,       ,       ,
       ,     | ,       ,   | | ,   | | ,  /|\| , |  \  ,       ,    \  ,  /    ,  /|\  ,   |   ,  /    ,       ,   |   ,  /    ,
       ,       ,       ,  ___  ,  ___  ,       ,  ___  ,       ,       ,       ,       ,       ,       ,       ,       ,       ,
original numerics
  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,       ,       ,       ,       ,       ,  ___  ,
 |  /| ,    /| ,     | ,     | , |   | , |     , |     ,     | , |   | , |   | ,       ,   |   ,    /  ,       ,  \    ,     | ,
       ,       ,  - -  ,    -  ,  - -  ,  -    ,  - -  ,       ,  - -  ,  - -  ,       ,       ,  -    ,  - -  ,    -  ,    -  ,
 |/  | ,     | , |     ,     | ,     | ,    \  , |   | ,     | , |   | ,     | ,   |   ,  /    ,    \  ,       ,  /    ,   |   ,
  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,  ___  ,       ,       ,       ,  ___  ,       ,       ,

_E

my $orig =<<'_END';
# 0x00 chinese numerics attempt
       ,       ,       ,  ___  ,  ___  ,  ___  ,       ,       ,       ,       ,       ,       ,       ,       ,       ,  ___  ,
       ,       ,       ,       , |\ /| ,   |   ,   |   ,   |   ,       ,   |   ,       ,   |   ,    /  ,       ,  \    ,     | ,
  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,       ,  - -  ,       ,       ,  -    ,  - -  ,    -  ,    -  ,
 |   | ,       ,       ,       ,       ,   | | ,  / \  ,  /    ,  / \  ,  /  | ,   |   ,  /    ,    \  ,       ,  /    ,   |   ,
  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,       ,  ___  ,       ,       ,       ,       ,       ,  ___  ,       ,       ,
# 0x10 chinese "scratch/flower" code attempt
  ___  ,       ,       ,       ,       ,  ___  ,       ,       ,  ___  ,  ___  ,       ,       ,       ,       ,       ,  ___  ,
 |   | ,   |   ,   | | , | | | ,  \ /  ,  \    ,   |   ,   |   ,   |   ,  \ /  ,       ,   |   ,    /  ,       ,  \    ,     | ,
  - -  ,       ,       ,       ,       ,    -  ,  - -  ,  - -  ,  - -  ,       ,       ,       ,  -    ,  - -  ,    -  ,    -  ,
       ,   |   ,   | | , | | | ,  / \  ,  /  | ,       ,       ,       ,  / \  ,   |   ,  /    ,    \  ,       ,  /    ,   |   ,
       ,       ,       ,       ,       ,  ___  ,       ,  ___  ,  ___  ,       ,       ,       ,       ,  ___  ,       ,       ,
# 0x20 default set
       ,       ,       ,       ,  ___  ,       ,  ___  ,       ,       ,       ,       ,       ,       ,       ,       ,       ,
       ,     | ,   | | ,   | | , | |   , |\|/  ,  \|   ,   |   ,    /  ,  \    ,  \|/  ,   |   ,       ,       ,       ,    /  ,
       ,       ,       ,  - -  ,  - -  ,  - -  ,  -    ,       ,       ,       ,  - -  ,  - -  ,       ,  - -  ,       ,       ,
       ,     | ,       ,   | | ,   | | ,  /|\| , |  \  ,       ,    \  ,  /    ,  /|\  ,   |   ,  /    ,       ,   |   ,  /    ,
       ,       ,       ,  ___  ,  ___  ,       ,  ___  ,       ,       ,       ,       ,       ,       ,       ,       ,       ,
  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,       ,       ,       ,       ,       ,  ___  ,
 |  /| ,    /| ,     | ,     | , |   | , |     , |     ,     | , |   | , |   | ,       ,   |   ,    /  ,       ,  \    ,     | ,
       ,       ,  - -  ,    -  ,  - -  ,  -    ,  - -  ,       ,  - -  ,  - -  ,       ,       ,  -    ,  - -  ,    -  ,    -  ,
 |/  | ,     | , |     ,     | ,     | ,    \  , |   | ,     | , |   | ,     | ,   |   ,  /    ,    \  ,       ,  /    ,   |   ,
  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,  ___  ,       ,       ,       ,  ___  ,       ,       ,
  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,       ,  ___  ,       ,       ,       ,       ,       ,  ___  ,
 | | | , |   | ,   | | , |     ,   | | , |     , |     , |     , |   | ,   |   ,     | , |  /  , |     , |\ /| , |\  | , |   | ,
    -  ,  - -  ,    -  ,       ,       ,  -    ,  -    ,    -  ,  - -  ,       ,       ,  -    ,       ,       ,       ,       ,
 |     , |   | ,   | | , |     ,   | | , |     , |     , |   | , |   | ,   |   , |   | , |  \  , |     , |   | , |  \| , |   | ,
  ___  ,       ,  ___  ,  ___  ,  ___  ,  ___  ,       ,  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,       ,       ,  ___  ,
  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,       ,       ,       ,       ,       ,  ___  ,  ___  ,       ,  ___  ,       ,       ,
 |   | , |   | , |   | , |     ,   |   , |   | , |  /  , |   | ,  \ /  , |   | ,    /  , |     ,  \    ,     | ,       ,       ,
  - -  ,       ,  - -  ,  - -  ,       ,       ,       ,       ,       ,  - -  ,       ,       ,       ,       ,       ,       ,
 |     , |  \| , |  \  ,     | ,   |   , |   | , |/    , |/ \| ,  / \  ,     | ,  /    , |     ,    \  ,     | ,  / \  ,       ,
       ,  ___  ,       ,  ___  ,       ,  ___  ,       ,       ,       ,  ___  ,  ___  ,  ___  ,       ,  ___  ,       ,  ___  ,
       ,       ,       ,       ,       ,       ,       ,       ,       ,       ,       ,       ,       ,       ,       ,       ,
  \    ,       , |     ,       ,     | ,       ,    /  ,    /| , |     ,       ,   |   ,   |/  , |     ,       ,       ,       ,
       ,  -    ,  -    ,  - -  ,    -  ,  -    ,  - -  ,    -  ,  -    ,       ,       ,       ,       ,  - -  ,  -    ,  - -  ,
       , | |   , |  \  , |     ,  /  | , |/    ,   |   ,     | , | |   ,   |   , |/    ,   |\  , |     , | | | , | |   , |   | ,
       ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,       ,  ___  ,       ,       ,       ,       ,       ,       ,       ,  ___  ,
       ,       ,       ,       ,       ,       ,       ,       ,       ,       ,       ,  ___  ,       ,  ___  ,       ,       ,
 |\    ,    /| ,       ,       , |     ,       ,       ,       ,  \ /  ,   | | ,       ,  \    ,   |   ,    /  ,    /  ,       ,
  -    ,    -  ,  -    ,    -  ,  -    ,       ,       ,       ,       ,    -  ,  -    ,  -    ,       ,    -  ,  - -  ,       ,
 |     ,     | , |     ,    \  , |     , |   | , |/    , |/ \| ,  / \  ,     | ,  /    ,  /    ,   |   ,    \  ,  /    ,       ,
       ,       ,       ,  ___  ,  ___  ,  ___  ,       ,       ,       ,  ___  ,  ___  ,  ___  ,       ,  ___  ,       ,       ,
# 0x80 chinese numerics attempt
       ,       ,       ,  ___  ,  ___  ,  ___  ,       ,       ,       ,       ,       ,       ,       ,       ,       ,  ___  ,
       ,       ,       ,       , |\ /| ,   |   ,   |   ,    /  ,       ,   |   ,       ,   |   ,    /  ,       ,  \    ,     | ,
       ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,  - -  ,       ,  - -  ,       ,       ,  -    ,  - -  ,    -  ,    -  ,
       ,       ,       ,       ,       ,   | | ,  / \  ,  /    ,  / \  ,  /  | ,   |   ,  /    ,    \  ,       ,  /    ,   |   ,
       ,       ,  ___  ,  ___  ,       ,  ___  ,       ,  ___  ,       ,       ,       ,       ,       ,  ___  ,       ,       ,
# 0x90 chinese "scratch/flower" code attempt
  ___  ,       ,       ,       ,       ,  ___  ,       ,       ,  ___  ,  ___  ,       ,       ,       ,       ,       ,  ___  ,
 |   | ,   |   ,   | | , | | | ,  \ /  , |  /  ,   |   ,   |   ,   |   ,  \ /  ,       ,   |   ,    /  ,       ,  \    ,     | ,
  - -  ,       ,       ,       ,       ,  - -  ,       ,  - -  ,  - -  ,       ,       ,       ,  -    ,  - -  ,    -  ,    -  ,
       ,   |   ,   | | , | | | ,  / \  ,  /  | ,   |   ,       ,       ,  / \  ,   |   ,  /    ,    \  ,       ,  /    ,   |   ,
       ,       ,       ,       ,       ,  ___  ,  ___  ,  ___  ,  ___  ,       ,       ,       ,       ,  ___  ,       ,       ,
# 0xa0 aurebesh (starwars) alphabet set
       ,       ,       ,       ,  ___  ,       ,  ___  ,       ,       ,       ,       ,       ,       ,       ,       ,       ,
       ,     | ,   | | ,   | | , | |   , |\|/  ,  \|   ,   |   ,    /  ,  \    ,  \|/  ,   |   ,       ,       ,       ,    /  ,
       ,       ,       ,  - -  ,  - -  ,  - -  ,  -    ,       ,       ,       ,  - -  ,  - -  ,       ,  - -  ,       ,       ,
       ,     | ,       ,   | | ,   | | ,  /|\| , |  \  ,       ,    \  ,  /    ,  /|\  ,   |   ,  /    ,       ,   |   ,  /    ,
       ,       ,       ,  ___  ,  ___  ,       ,  ___  ,       ,       ,       ,       ,       ,       ,       ,       ,       ,
  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,  ___  ,  ___  ,  ___  ,  ___  ,       ,       ,       ,       ,       ,  ___  ,
 |   | ,   |   ,     | ,     | , |   | ,       ,       ,     | , |   | , |   | ,   |   ,   |   ,    /  ,       ,  \    ,     | ,
  -    ,       ,  - -  ,  -    ,  - -  ,  - -  ,  - -  ,       ,  - -  ,  - -  ,       ,       ,  -    ,  - -  ,    -  ,    -  ,
 |   | ,   |   ,       ,     | ,     | ,     | , |   | ,     | , |   | ,       ,   |   ,  /    ,    \  ,       ,  /    ,   |   ,
  ___  ,  ___  ,  ___  ,  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,  ___  ,       ,       ,       ,  ___  ,       ,       ,
  ___  ,       ,  ___  ,       ,  ___  ,       ,       ,  ___  ,  ___  ,       ,       ,  ___  ,       ,       ,       ,       ,
 | | | , |  /  , |     , | | | ,    /  , |  /| ,   |/  , |  /  ,       ,    /| ,    /| ,     | ,     | ,       ,       ,       ,
    -  ,  -    ,    -  ,       ,  -    ,    -  ,  -    ,  -    ,  -    ,       ,  -    ,  - -  ,       ,    -  ,       ,    -  ,
 |     , |  \  , |     ,     | ,  /    , |/  | , | |   ,       ,       ,     | ,     | ,       ,    \| ,  /    , |/ \  ,  / |  ,
  ___  ,       ,  ___  ,       ,       ,       ,  ___  ,       ,  ___  ,       ,  ___  ,       ,       ,  ___  ,       ,  ___  ,
       ,  ___  ,  ___  ,       ,       ,       ,       ,  ___  ,       ,       ,       ,  ___  ,       ,  ___  ,       ,       ,
       , |   | ,    /  ,  \  | ,  \|/  , |  /| ,  \ /  , |   | ,       ,  \|   ,       , |     ,  \    ,     | ,       ,       ,
  -    ,       ,       ,       ,       ,       ,       ,  - -  ,       ,       ,    -  ,       ,       ,       ,       ,       ,
 |   | , |     ,  /    ,    \| ,       , |   | ,   |   ,       ,  / \  ,    \| ,  /  | , |     ,    \  ,     | ,  / \  ,       ,
  ___  ,  ___  ,       ,  ___  ,       ,  ___  ,       ,       ,  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,       ,  ___  ,
       ,       ,  ___  ,       ,  ___  ,       ,       ,  ___  ,  ___  ,       ,       ,  ___  ,       ,       ,       ,       ,
  \    , |  /  , |     , | | | ,    /  , |  /| ,   |/  , |  /  ,       ,    /| ,    /| ,     | ,     | ,       ,       ,       ,
       ,  -    ,    -  ,       ,  -    ,    -  ,  -    ,  -    ,  -    ,       ,  -    ,  - -  ,       ,    -  ,       ,    -  ,
       , |  \  , |     ,     | ,  /    , |/  | , | |   ,       ,       ,     | ,     | ,       ,    \| ,  /    , |/ \  ,  / |  ,
       ,       ,  ___  ,       ,       ,       ,  ___  ,       ,  ___  ,       ,  ___  ,       ,       ,  ___  ,       ,  ___  ,
       ,  ___  ,  ___  ,       ,       ,       ,       ,  ___  ,       ,       ,       ,  ___  ,       ,  ___  ,       ,       ,
       , |   | ,    /  ,  \  | ,  \|/  , |  /| ,  \ /  , |   | ,       ,  \|   ,       ,  \    ,   |   ,    /  ,    /  ,       ,
  -    ,       ,       ,       ,       ,       ,       ,  - -  ,       ,       ,    -  ,  -    ,       ,    -  ,  - -  ,       ,
 |   | , |     ,  /    ,    \| ,       , |   | ,   |   ,       ,  / \  ,    \| ,  /  | ,  /    ,   |   ,    \  ,  /    ,       ,
  ___  ,  ___  ,       ,  ___  ,       ,  ___  ,       ,       ,  ___  ,       ,  ___  ,  ___  ,       ,  ___  ,       ,       ,

_END

# aurebesh (starwars) alphabet

sub gen_file {
	my ($fn, $dg, $sg) = @_;

	open O, ">$fn.h" or die "cannot create file $fn.h\n";
	print O "const uint8_t digit_map[]   = { ", join ", ", @{$dg}, " };\n";
	print O "const uint8_t digit_map_r[]   = { ", join ", ", reverse(@{$dg}), " };\n\n";

	my $o = join '', qw/a   b   c   d   e   f   g   G   h   i   j   k   l   m   D/;
			 
	my @r = qw/d   e   f   a   b   c   G   g   m   l   k   j   i   h   D/;

	my $mask = 0;
	my @spin_mask = ();
	my $bit16=1;
	for my $b (@{$sg}) {
		$mask |= 1<<$b;
		$b > 15 and $bit16=0;
		push @spin_mask, $mask;
	}

	if ($fn =~ m/l/) {
		print O "#define ENABLE_154	15\n";		# for ver2l pin 15 enables 75hc154d
		print O "#define NUM_OF_DIGITS	24\n";
	}
	else {
		print O "#define NUM_OF_DIGITS	12\n";
	}
	$bit16 and printf O "#define BIT16_SEG	1\n";
	printf O "const uint32_t segment_maskA = 0x%08x;\n", $mask & 0xffffffff;
	printf O "const uint32_t segment_maskB = 0x%08x;\n", $mask >> 32;

	for my $b (@{$dg}) {
		$mask |= 1<<$b;
	}
	printf O "const uint32_t all_maskA = 0x%08x;\n", $mask & 0xffffffff;
	printf O "const uint32_t all_maskB = 0x%08x;\n", $mask >> 32;
	print O "const uint32_t spin_maskA[] = {\n";
	my $cnt=0;
	for (@spin_mask) {
		printf O "0x%08x, ", $_ & 0xffffffff;
		++$cnt % 4 or print O "\n";
	}
	print O "};\n";

	print O "const uint32_t spin_maskB[] = {\n";
	$cnt=0;
	for (@spin_mask) {
		printf O "0x%08x, ", $_ >> 32;
		++$cnt % 4 or print O "\n";
	}
	print O "};\n";


	my @brightness = ();

	my ($a0, $a1, $a2) = (
		"const uint32_t asciiA[] = {\n",
		"const uint32_t asciiB[] = {\n",
		"const uint8_t asciiOnOff[] = {\n",);

	#for my $raw ($orig, $full) {
	for my $raw ($orig) {
		my $c = 0;
		my @row = ();
		my $m = "abcdefgGhijklm";
		my $m0 = " a   fhijb g G eklmc d   ";
		my $m1 = " d   cmlke G g bjihf a   ";
		for (split('\n', $raw)) {
			/,/ or next;
			$c or @row = ();
			my @col = split ',', $_;
			@col = map(substr($_, 1, 5), @col);
			my $i = 0;
			for my $e (@col) {
				$row[$i++] .= $e;
			}
			++$c == 5 and do {
				#print O "($row[1])\n";
				for my $i (0..15) {
					my @seg = split '', $row[$i];
					my ($a, $b, $c, $cn) = (0, 0, 0, 0);
					for (split '', $m) {
						#$seg[index($m0, $_)] ne ' ' and $a |= $cmp;
						#$seg[index($m1, $_)] ne ' ' and $b |= $cmp;
						#$cmp <<= 1;
						$seg[index($m0, $_)] ne ' ' and do { $a |= 1<<$sg->[$c]; $cn++; };
						$seg[index($m1, $_)] ne ' ' and $b |= 1<<$sg->[$c];
						$c++;
					}
					push @brightness, $cn;
					#$a0 .= sprintf O "0x%04x, ", $a;
					#$a1 .= sprintf O "0x%04x, ", $b;
					$a0 .= sprintf "0x%08x, ", ($a & 0xffffff) | (($a >> 32) << 24);
					$a1 .= sprintf "0x%08x, ", ($b & 0xffffff) | (($b >> 32) << 24);
					$i == 7 and do {
						$a0 .= "\n";
						$a1 .= "\n";
					};
				}
				$a0 .= "\n";
				$a1 .= "\n";
				$c = 0;
			};
		}
		$a0 .= "};\n\n";
		$a1 .= "};\n\n";
		print O $a0, $a1;

		print O $a2;
		for (@brightness) {
			printf O "0x%02x, ", $_;
			++$c & 0x7 or print O "\n";
		}
		print O "};\n\n";

		($a0, $a1, $a2) = (
			"const uint32_t aurebeshA[] = {\n",
			"const uint32_t aurebeshB[] = {\n",
			"const uint8_t aurebeshOnOff[] = {\n",);
		@brightness = ();
	}
	close O;
}

#my @digits = (  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, );	# ver1
#my @digits = ( 10, 12, 13, 14, 16,  8, 11, 35, 38, 37, 40, 39, );	# ver2
#my @digits = ( 34, 16, 17, 18, 21, 33, 36, 35, 37, 38, 39, 40, );	# ver2l
#my @p = ( 13, 14, 15, 16, 17, 18, 21, 33, 34, 35, 36, 39, 38, 37, 38, );		# ver1
#my @p = ( 17, 21,  1,  3,  2, 18,  5,  4, 34, 33, 36,  9,  6,  7, 15, );		# ver2
#my @p = ( 11, 13,  1,  5,  2, 14,  3,  4,  8,  9, 10, 12,  6,  7,  6, );		# ver2l

gen_file("ver1", 
	[  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12,],
	[ 13, 14, 15, 16, 17, 18, 21, 33, 34, 35, 36, 39, 38, 37, 38,]);

gen_file("ver2", 
	[ 10, 12, 13, 14, 16,  8, 11, 35, 38, 37, 40, 39,],
	[ 17, 21,  1,  3,  2, 18,  5,  4, 34, 33, 36,  9,  6,  7, 15,]);

gen_file("ver2l", 
	[ 34, 16, 17, 18, 21, 33, 36, 35, 37, 38, 39, 40,],
	[ 11, 13,  1,  5,  2, 14,  3,  4,  8,  9, 10, 12,  6,  7,  6,]);

